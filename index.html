<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
    <meta name="description" content="Esri App Challenge 2019">

    <title>Transportation Justice</title>

    <!-- Calcite Maps Bootstrap -->
    <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-bootstrap.min-v0.10.css">
    <!--link rel="stylesheet" href="http://localhost/GitHub/calcite-maps/dist/css/calcite-maps-bootstrap.min-v0.10.css"-->

    <!-- Calcite Maps -->
    <link rel="stylesheet" href="https://esri.github.io/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.10.css">
    <!--link rel="stylesheet" href="http://localhost/GitHub/calcite-maps/dist/css/calcite-maps-arcgis-4.x.min-v0.10.css"-->

    <!-- ArcGIS JS 4 -->
    <link rel="stylesheet" href="https://js.arcgis.com/4.10/esri/css/main.css">

    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
        }
    </style>

</head>

<body class="calcite-maps calcite-nav-top">
<!-- Navbar -->

<nav class="navbar calcite-navbar navbar-fixed-top calcite-text-light calcite-bg-dark">
    <!-- Menu -->
    <div class="dropdown calcite-dropdown calcite-text-dark calcite-bg-light" role="presentation">
        <a class="dropdown-toggle" role="menubutton" aria-haspopup="true" aria-expanded="false" tabindex="0">
            <div class="calcite-dropdown-toggle">
                <span class="sr-only">Toggle dropdown menu</span>
                <span></span>
                <span></span>
                <span></span>
                <span></span>
            </div>
        </a>
        <ul class="dropdown-menu" role="menu">
            <li><a role="menuitem" tabindex="0" data-target="#panelInfo" aria-haspopup="true"><span
                    class="glyphicon glyphicon-info-sign"></span> About</a></li>
            <li><a role="menuitem" tabindex="0" href="#" id="calciteToggleNavbar" aria-haspopup="true"><span
                    class="glyphicon glyphicon-fullscreen"></span> Full Map</a></li>
        </ul>
    </div>
    <!-- Title -->
    <div class="calcite-title calcite-overflow-hidden">
        <span class="calcite-title-main">Transportation Justice</span>
        <span class="calcite-title-divider hidden-xs"></span>
        <span class="calcite-title-sub hidden-xs">text text text</span>
    </div>
    <!-- Nav -->
    <ul class="nav navbar-nav calcite-nav">
        <li>
            <div class="calcite-navbar-search calcite-search-expander">
                <div id="searchWidgetDiv"></div>
            </div>
        </li>
    </ul>
</nav>

<!--/.calcite-navbar -->

<!-- Map  -->

<div class="calcite-map calcite-map-absolute">
    <div id="mapViewDiv"></div>
</div>

<!-- /.calcite-map -->

<!-- Panels -->

<div class="calcite-panels calcite-panels-right calcite-text-light calcite-bg-dark panel-group">

    <!-- Panel - Basemaps -->

    <div id="panelInfo" class="panel collapse in">
        <div id="headingInfo" class="panel-heading" role="tab">
            <div class="panel-title">
                <a class="panel-toggle" role="button" data-toggle="collapse" href="#collapseInfo" aria-expanded="true"
                   aria-controls="collapseInfo"><span class="glyphicon glyphicon-info-sign"
                                                      aria-hidden="true"></span><span
                        class="panel-label">Settings</span></a>
                <a class="panel-close" role="button" data-toggle="collapse" tabindex="0" href="#panelInfo"><span
                        class="esri-icon esri-icon-close" aria-hidden="true"></span></a>
            </div>
        </div>


        <div id="collapseInfo" class="panel-collapse collapse in" role="tabpanel" aria-labelledby="headingInfo">
            <div class="panel-body">

                <ul class="nav nav-tabs">
                    <li class="active"><a data-toggle="tab" href="#home">Directions</a></li>
                    <li><a data-toggle="tab" href="#menu1">Service Area</a></li>
                    <li><a data-toggle="tab" href="#menu2">Neighborhood</a></li>
                </ul>
                <div class="tab-content">

                    <div id="home" class="tab-pane fade in active">
                        <div class="calcite-form-title">Set Origin & Destination</div>
                        <label for="SrcInput" class="col-xs-3">Origin</label>
                        <div class="col-xs-9">
                            <div id="SrcInput" class="calcite-form-search"></div>
                        </div>

                        <label for="DstInput" class="col-xs-3">Destination</label>
                        <div class="col-xs-9">
                            <div id="DstInput" class="calcite-form-search"></div>
                        </div>


                    </div>
                    <div id="menu1" class="tab-pane fade">
                        <div class="calcite-form-title">Set Origin and Travel Time</div>
                        <label for="originContainer" class="col-xs-3 control-label">Location</label>
                        <div class="col-xs-9">
                            <div id="originContainer" class="calcite-form-search"></div>
                        </div>
                        <label for="selectTravelTime" class="col-xs-3 control-label">Time (min)</label>
                        <div class="col-xs-9">
                            <select id="selectTravelTime" class="form-control">
                                <option value="15">15</option>
                                <option value="30">30</option>
                                <option value="45">45</option>
                                <option value="60">60</option>
                            </select>
                        </div>
                    </div>
                    <div id="menu2" class="tab-pane fade">
                        <div class="calcite-form-title">Set Destination</div>
                        <label for="neighborSearchContainer" class="col-xs-3 control-label">Location</label>
                        <div class="col-xs-9">
                            <div id="neighborSearchContainer" class="calcite-form-search"></div>
                        </div>
                    </div>
                </div>


            </div><!-- /.panel-body -->
        </div><!-- /.panel-collapse -->


    </div>

</div>

<!-- /.calcite-panels -->

<script type="text/javascript">
    var dojoConfig = {
        packages: [{
            name: "bootstrap",
            location: location.pathname.replace(/\/[^/]+$/, "") + "/dist/vendor/dojo-bootstrap"
        },
        {
            name: "calcite-maps",
            location: location.pathname.replace(/\/[^/]+$/, "") + "/dist/js/dojo"
        }]
    };
</script>

<!-- ArcGIS JS 4 -->
<script src="https://js.arcgis.com/4.10/"></script>

<script>

    require([
        // ArcGIS
        "esri/Map",
        "esri/views/MapView",

        // Widgets
        "esri/widgets/Home",
        "esri/widgets/Zoom",
        "esri/widgets/Search",
        "esri/widgets/ScaleBar",
        "esri/widgets/Attribution",

        "esri/Graphic",
        "esri/geometry/support/webMercatorUtils",
        "esri/tasks/Locator",
        "esri/layers/GraphicsLayer",
        "esri/tasks/RouteTask",
        "esri/tasks/support/RouteParameters",
        "esri/tasks/support/FeatureSet",
        "esri/tasks/ServiceAreaTask",
        "esri/tasks/support/ServiceAreaParameters",
        "esri/request",
        "esri/layers/FeatureLayer",
        "esri/geometry/projection",

        // Bootstrap
        "bootstrap/Collapse",
        "bootstrap/Dropdown",
        "bootstrap/Tab",

        // Calcite Maps
        "calcite-maps/calcitemaps-v0.10",

        // Calcite Maps ArcGIS Support
        "calcite-maps/calcitemaps-arcgis-support-v0.10",

        "dijit/form/TimeTextBox",
        "dojo/query",
        "dojo/domReady!"
    ], function (Map, MapView, Home, Zoom, Search, ScaleBar, Attribution, Graphic, webMercatorUtils, Locator,
                 GraphicsLayer, RouteTask, RouteParameters, FeatureSet, ServiceAreaTask, ServiceAreaParameters, esriRequest,
                 FeatureLayer, projection, Collapse, Dropdown, Tab, CalciteMaps, CalciteMapArcGISSupport, TimeTextBox, query) {

        /******************************************************************
         *
         * Create the map, view and widgets
         *
         ******************************************************************/

        var tabMode = 0;

        var routeLayer = new GraphicsLayer();
        // Map
        var samplePointsLayer = new FeatureLayer({
            url: "https://services.arcgis.com/4TKcmj8FHh5Vtobt/arcgis/rest/services/Toronto_Neighborhood/FeatureServer/0?token=qIqNnGzb1_pJJtTBEKiD3jDjbruo81X8HFvrYC2EhZ55iizDpQkdwa8BJXEjWVMt4Z-C8fb_C1FWY_gP1vDczmJWnM7rlv31v257XVNTwiKjqT-1tIzzafldzKv-lUQAxIRdlGpO6dmtsR_UuwZuoCP43-TyZNhR7EoLOh3x7z2GnOW-7_nhdUUfN-it1i8biYGKx1TJzePefFdObKGIlc2bCkMCwwDv2lNvone7pAU46BD2AIBOnCz-JFic8AhX"
        });
        var neighborhoodLayer = new FeatureLayer({
            url: "https://services.arcgis.com/4TKcmj8FHh5Vtobt/arcgis/rest/services/Toronto_Neighborhood/FeatureServer/1?token=AQCRI6YYw9G1krHdjvxxP0zCEIQ3IhdYBLLD7-vXkKLouoHHggxTIvTk_2H0JElWW7HSAb2YzLMRmrwy2i5b00GgNb9f87DvIXjw9yJEHyDKKokDQDqMYeDx6xbR8JrCoP8Az8scJwDo8B7KkxaOvPdXPzfb9O97vJiQRjBMOBqMqRGciFa1zqOB7VCMJR-MbqPjXgTtCo7jj50TSUfogQ.."
        });
        var map = new Map({
            basemap: "dark-gray-vector",
            layers: [routeLayer, neighborhoodLayer] // Add the route layer to the map
        });

        // View
        var mapView = new MapView({
            container: "mapViewDiv",
            map: map,
            zoom: 10, // Sets zoom level based on level of detail (LOD)
            center: [-79.4163, 43.70011], // Sets center point of view using longitude,latitude
            padding: {
                top: 50,
                bottom: 0
            },
            ui: {components: []}
        });


        var polyCentroids;
        var transitTimeArray = [];
        var drivingTimeArray = [];
        var diffTimeArray = [];
        // Popup and panel sync
        mapView.when(function () {
            CalciteMapArcGISSupport.setPopupPanelSync(mapView);
            //console.log("loaded");
            //console.log(query('a[data-toggle="tab"]'));
            query('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
                tabMode = query('a[data-toggle="tab"]').indexOf(this);
                mapView.graphics.removeAll();
                routeLayer.graphics.removeAll();
                srcGraphic = 0;
                dstGraphic = 0;
            })

            neighborhoodLayer.queryFeatures().then(function(results){
                // prints an array of all the features in the service to the console
                //console.log(results.features);
                polyCentroids = results.features.map(function(feature) {
                    //return feature.geometry;
                    return feature.geometry.centroid;

                });
                //console.log(polyCentroids);
            });
        });

        // Search - add to navbar
        var srcSearchWidget = new Search({
            container: "SrcInput",
            view: mapView,
            locationEnabled: false,
            autoSelect: false,
            placeholder: "Choose origin point, or click on the map"
        });
        var dstSearchWidget = new Search({
            container: "DstInput",
            view: mapView,
            locationEnabled: false,
            autoSelect: false
        });
        //CalciteMapArcGISSupport.setSearchExpandEvents(searchWidget);

        var timeText = new TimeTextBox({
            name: "progval", value: new Date(),
            constraints: {
                timePattern: 'HH:mm:ss',
                clickableIncrement: 'T00:15:00',
                visibleIncrement: 'T00:15:00',
                visibleRange: 'T01:00:00'
            }
        }, "progval").startup();


        // Map widgets
        var home = new Home({
            view: mapView
        });
        mapView.ui.add(home, "top-left");

        var zoom = new Zoom({
            view: mapView
        });
        mapView.ui.add(zoom, "top-left");


        var scaleBar = new ScaleBar({
            view: mapView
        });
        mapView.ui.add(scaleBar, "bottom-left");

        var attribution = new Attribution({
            view: mapView
        });
        mapView.ui.add(attribution, "manual");

        // // Panel widgets - add legend
        // var legendWidget = new Legend({
        //     container: "legendDiv",
        //     view: mapView
        // });

        var srcGraphic, dstGraphic;
        var srcDropPinActive = false;
        var dstDropPinActive = false;

        // Create a symbol for drawing the point
        var srcMarkerSymbol = {
            type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
            color: "#DC143C",
            outline: {
                // autocasts as new SimpleLineSymbol()
                color: [255, 255, 255],
                width: 2
            }
        };
        var dstMarkerSymbol = {
            type: "simple-marker", // autocasts as new SimpleMarkerSymbol()
            color: "#228B22",
            outline: {
                // autocasts as new SimpleLineSymbol()
                color: [255, 255, 255],
                width: 2
            }
        };
        var routeSymbol = {
            type: "simple-line", // autocasts as SimpleLineSymbol()
            color: [255, 255, 255, 0.5],
            width: 5
        };

        mapView.on("click", function (event) {
            //console.log("click event: ", event);
            //var point = mapView.toMap({x: event.x, y: event.y});
            //console.log(point);
            //var mp = webMercatorUtils.webMercatorToGeographic(point);
            //console.log(mp);

            switch (tabMode) {
                case 0:
                    addGraphic(event.mapPoint);
                    break;
                case 1:
                    computeServiceArea(event.mapPoint);
                    break;
                case 2:
                    //ODMatrix(event.mapPoint);
                    diffODMatrix(event.mapPoint);
                    break;
            }

        });


        var locatorTask = new Locator({
            url:
                "https://geocode.arcgis.com/arcgis/rest/services/World/GeocodeServer"
        });
        var routeTask = new RouteTask({
            url:
                "https://utility.arcgis.com/usrsvcs/appservices/skHSU1JsOEZauhMu/rest/services/World/Route/NAServer/Route_World/solve"
        });
        // Setup the route parameters
        var routeParams = new RouteParameters({
            stops: new FeatureSet(),
            outSpatialReference: {
                // autocasts as new SpatialReference()
                wkid: 3857
            },
            startTime: 0,
            returnDirections: true
        });


        srcSearchWidget.on("search-start", function (event) {
            mapView.graphics.remove(srcGraphic);
        });
        srcSearchWidget.on("search-clear", function (event) {
            mapView.graphics.remove(srcGraphic);
        });
        srcSearchWidget.on("search-complete", function (event) {
            if (event.numResults > 0) {
                srcGraphic = event.results[0].results[0].feature;
                srcGraphic.symbol = srcMarkerSymbol;
                mapView.graphics.add(srcGraphic);
                route();
            }
        });
        srcSearchWidget.on("search-focus", function (event) {
            srcDropPinActive = true;
        });

        dstSearchWidget.on("search-start", function (event) {
            mapView.graphics.remove(dstGraphic);
        });
        dstSearchWidget.on("search-clear", function (event) {
            mapView.graphics.remove(dstGraphic);
        });
        dstSearchWidget.on("search-complete", function (event) {
            if (event.numResults > 0) {
                dstGraphic = event.results[0].results[0].feature;
                dstGraphic.symbol = dstMarkerSymbol;
                mapView.graphics.add(dstGraphic);
                route();
            }
        });
        dstSearchWidget.on("search-focus", function (event) {
            dstDropPinActive = true;
        });


        function route() {
            routeLayer.graphics.removeAll();
            if (srcGraphic && dstGraphic) {
                routeParams.stops.features.pop();
                routeParams.stops.features.pop();
                routeParams.stops.features.push(srcGraphic);
                routeParams.stops.features.push(dstGraphic);

                routeParams.startTime = new Date();
                routeTask.solve(routeParams).then(showRoute);
            }
        }

        function addGraphic(pt) {
            // var point = {
            //     type: "point", // autocasts as new Point()
            //     longitude: -79.4163,
            //     latitude: 43.70011
            // };
            // var pointGraphic = new Graphic({
            //     geometry: pt,
            //     symbol: srcMarkerSymbol
            // });
            // mapView.graphics.add(pointGraphic);
            //
            if (srcDropPinActive || dstDropPinActive) {

                var searchWidget = srcDropPinActive ? srcSearchWidget : dstSearchWidget;
                mapView.graphics.remove(srcDropPinActive ? srcGraphic : dstGraphic);

                //routeLayer.graphics.removeAll();


                locatorTask
                    .locationToAddress(pt)
                    .then(function (response) {
                        // If an address is successfully found, show it in the popup's content
                        //console.log(response.address);
                        searchWidget.searchTerm = response.address;
                    })
                    .catch(function (error) {
                        // If the promise fails and no result is found, show a generic message
                        console.log("No address was found for this location");
                    });

                if (srcDropPinActive) {
                    srcGraphic = new Graphic({
                        geometry: pt,
                        symbol: srcMarkerSymbol
                    });
                    mapView.graphics.add(srcGraphic);
                    srcDropPinActive = false;
                } else {
                    dstGraphic = new Graphic({
                        geometry: pt,
                        symbol: dstMarkerSymbol
                    });
                    mapView.graphics.add(dstGraphic);
                    dstDropPinActive = false;
                }
            }

            route();

        }

        // Adds the solved route to the map as a graphic
        function showRoute(data) {
            var routeResult = data.routeResults[0].route;
            routeResult.symbol = routeSymbol;
            routeLayer.add(routeResult);

        }


        var originSearchWidget = new Search({
            container: "originContainer",
            view: mapView,
            locationEnabled: false,
            autoSelect: false,
            placeholder: "Choose origin point, or click on the map"
        });
        var serviceAreaTask = new ServiceAreaTask({
            url: "https://utility.arcgis.com/usrsvcs/appservices/tbM4mfm4indqaBya/rest/services/World/ServiceAreas/NAServer/ServiceArea_World/solveServiceArea"
        });
        // Setup the service area parameters
        var serviceAreaParams = new ServiceAreaParameters({
            defaultBreaks: [15],
            outSpatialReference: map.spatialReference,
            returnFacilities: false,
            facilities: new FeatureSet(),
            timeOfDay: new Date()
        });

        var serviceAreaTTAPI = {
            url: "https://api.traveltimeapp.com/v4/time-map",
        };
        var serviceAreaTTAPIParam = {
            headers : {
                "Host": "api.traveltimeapp.com",
                "Content-Type": "application/json",
                "Accept": "application/json",
                "X-Application-Id": "118cbc38",
                "X-Api-Key": "2e338f2d5171f25ed1a497f5eab24ec2"
            },
            method: "post",
            responseType: "json",
            body : JSON.stringify({
                "departure_searches": [
                    {
                        "id": "origin",
                        "coords": {
                            "lat": 51.507609,
                            "lng": -0.128315
                        },
                        "transportation": {
                            "type": "public_transport"
                        },
                        "departure_time": "2019-04-05T012:00:00Z",
                        "travel_time": 900
                    }
                ]
            })
        };



        function timetravel(pt) {
            serviceAreaTTAPIParam.body = JSON.stringify({
                "departure_searches": [
                    {
                        "id": "origin",
                        "coords": {
                            "lat": pt.y,
                            "lng": pt.x
                        },
                        "transportation": {
                            "type": "public_transport"
                            //"walking_time":0
                        },
                        "departure_time": (new Date()).toISOString(),
                        "travel_time": parseInt(query("#selectTravelTime").attr('value')[0])*60
                        // "range": {
                        //     "enabled": true,
                        //     "width": 3600
                        // }
                    }
                ]})
            console.log(serviceAreaTTAPIParam.body);
            esriRequest(serviceAreaTTAPI.url, serviceAreaTTAPIParam).then(function(response){
                // The requested data
                console.log(response.data);
               // console.log(response.data.results[0].shapes[0].shell);

                response.data.results[0].shapes.forEach(function(shape) {
                    var ring = [];
                    shape.shell.forEach(function (element) {
                        //console.log(element);
                        ring.push([element.lng, element.lat]);
                    });

                    var polygon = {
                        type: "polygon", // autocasts as new Polygon()
                        rings: ring
                    };
                    var fillSymbol = {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: [227, 139, 79, 0.8],
                        outline: {
                            // autocasts as new SimpleLineSymbol()
                            color: [255, 255, 255],
                            width: 1
                        }
                    };

                    // Add the geometry and symbol to a new graphic
                    var polygonGraphic = new Graphic({
                        geometry: polygon,
                        symbol: fillSymbol
                    });
                    routeLayer.add(polygonGraphic);
                });
            });
        }

        function computeServiceArea(pt) {
            //console.log(pt);
            var mp = webMercatorUtils.webMercatorToGeographic(pt);
            //console.log(mp);
            timetravel(mp);

            mapView.graphics.removeAll();
            routeLayer.graphics.removeAll();
            var originMarkerSymbol = {
                type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
                style: "diamond",
                color: "blue",
                size: "8px",  // pixels
                outline: {  // autocasts as new SimpleLineSymbol()
                    color: [255, 255, 0],
                    width: 3  // points
                }
            };

            var originGraphic = new Graphic({
                geometry: pt,
                symbol: originMarkerSymbol
            });
            mapView.graphics.add(originGraphic);

            //console.log(parseInt(query("#selectTravelTime").attr('value')[0]));
            serviceAreaParams.defaultBreaks = [parseInt(query("#selectTravelTime").attr('value')[0])];
            serviceAreaParams.timeOfDay = new Date();

            serviceAreaParams.facilities.features.pop();
            serviceAreaParams.facilities.features.push(originGraphic);
            serviceAreaTask.solve(serviceAreaParams).then(showServiceArea);
        }

        function showServiceArea(solveResult) {
            //console.log("showServiceArea");
            //console.log(solveResult);
            var polygonSymbol = {
                type: "simple-fill",  // autocasts as new SimpleFillSymbol()
                color: [232, 104, 80, 0.25],
                style: "solid",
                outline: {  // autocasts as new SimpleLineSymbol()
                    color: "white",
                    width: 2
                }
            };
            var sa = solveResult.serviceAreaPolygons[0];
            sa.symbol = polygonSymbol;
            routeLayer.add(sa);

            // arrayUtils.forEach(solveResult.serviceAreaPolygons, function(sa){
            //     console.log("result");
            //     sa.symbol = polygonSymbol;
            //     routeLayer.add(sa);
            // });
        }

        var neighborSearchWidget = new Search({
            container: "neighborSearchContainer",
            view: mapView,
            locationEnabled: false,
            autoSelect: false,
            placeholder: "Choose origin point, or click on the map"
        });

        // var routeREST = {
        //     url: "https://route.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World/solve",
        // };
        var routeTTimeAPI = {
            url: "https://api.traveltimeapp.com/v4/routes",
        };
        var routeTTAPIParam = {
            headers : {
                "Host": "api.traveltimeapp.com",
                "Content-Type": "application/json",
                "Accept": "application/json",
                "X-Application-Id": "118cbc38",
                "X-Api-Key": "2e338f2d5171f25ed1a497f5eab24ec2"
            },
            method: "post",
            responseType: "json",
            body : JSON.stringify({
                "locations": [
                    {
                        "id": "London center",
                        "coords": {
                            "lat": 51.508930,
                            "lng": -0.131387
                        }
                    },
                    {
                        "id": "Hyde Park",
                        "coords": {
                            "lat": 51.508824,
                            "lng": -0.167093
                        }
                    }
                ],
                "departure_searches": [
                    {
                        "id": "departure search example",
                        "departure_location_id": "London center",
                        "arrival_location_ids": [
                            "Hyde Park"
                        ],
                        "transportation": {
                            "type": "public_transport"
                        },
                        "departure_time": (new Date()).toISOString(),
                        "properties": ["travel_time"]
                    }
                ]
            })
        };


        function computeRouteTTAPI(pt) {
            var mp = webMercatorUtils.webMercatorToGeographic(pt);
            var outSpatialReference = {
                wkid: 4326
            };
            // projects an array of points
            //console.log(polyCentroids);
            //var projectedPoints = projection.project(polyCentroids, outSpatialReference);
            projection.load().then(function() {
                var projectedPoints = projection.project(polyCentroids, outSpatialReference);
                //console.log(projectedPoints);


                projectedPoints.forEach(function(poly, i) {
                    routeTTAPIParam.body = JSON.stringify({
                        "locations": [
                            {
                                "id": "src",
                                "coords": {
                                    "lat": poly.y,
                                    "lng": poly.x
                                }
                            },
                            {
                                "id": "dst",
                                "coords": {
                                    "lat": mp.y,
                                    "lng": mp.x
                                }
                            },
                        ],
                        "departure_searches": [{
                            "id": "departure search example",
                            "departure_location_id": "src",
                            "arrival_location_ids": [
                                "dst"
                            ],
                            "transportation": {
                                "type": "driving"
                            },
                            "departure_time": (new Date()).toISOString(),
                            "properties": ["travel_time", "distance", "route"]
                        }]
                    });
                    //console.log(routeTTAPIParam);
                    esriRequest(routeTTimeAPI.url, routeTTAPIParam).then(function(response){
                        // The requested data
                        //console.log(response.data);
                        //console.log(response.data.results[0].locations[0].properties[0].travel_time/60);

                        transitTimeArray[i] = response.data.results[0].locations[0].properties[0].travel_time/60;
                        updateDiff();
                    }); //request
                }); //foreach
            }); //load

        }

        function ODMatrix(pt) {
            mapView.graphics.removeAll();
            routeLayer.graphics.removeAll();

            transitTimeArray = new Array(polyCentroids.length).fill(120);
            drivingTimeArray = new Array(polyCentroids.length).fill(120);
            diffTimeArray = new Array(polyCentroids.length).fill(120);

            dstGraphic = new Graphic({
                geometry: pt,
                symbol: dstMarkerSymbol
            });
            mapView.graphics.add(dstGraphic);

            //computeRouteTTAPI(pt);

            polyCentroids.forEach(function(poly, i) {
                //console.log(poly.spatialReference.wkid);
                srcGraphic = new Graphic({
                    geometry: poly,
                    symbol: srcMarkerSymbol
                });
                mapView.graphics.add(srcGraphic);
                //console.log(poly.distance(pt));
                routeParams.stops.features.pop();
                routeParams.stops.features.pop();
                routeParams.stops.features.push(srcGraphic);
                routeParams.stops.features.push(dstGraphic);

                routeParams.startTime = new Date();
                //routeParams.returnDirections = true;

                //console.log(JSON.stringify(routeParams.stops.features));

                //var url = routeREST.url + "?stops={\"features\":" + JSON.stringify(routeParams.stops.features) + "}&f=json&token=6QMfjGCpFn3Fx6ZuRtQrderwkLEap4tQqn27vkqyZ5b_l0y3bLtrXCZO12QbkerWFa6Cq4KN_cvUf7eH3Z6glcYZ_gdv96DW8_hKiU8HZdazLyiCTk1frrZ2cjk_UP-3mpbTJyhAknjqYWL_20CRoA..";
                //var mpt = webMercatorUtils.webMercatorToGeographic(pt);
                //var mpoly = webMercatorUtils.webMercatorToGeographic(poly);
                //var url = routeREST.url + "?stops=" + poly.longitude + "," + poly.latitude + ";" + mpt.y + "," + mpt.x + "&f=json&token=6QMfjGCpFn3Fx6ZuRtQrderwkLEap4tQqn27vkqyZ5b_l0y3bLtrXCZO12QbkerWFa6Cq4KN_cvUf7eH3Z6glcYZ_gdv96DW8_hKiU8HZdazLyiCTk1frrZ2cjk_UP-3mpbTJyhAknjqYWL_20CRoA.."
                //console.log(url);
                // esriRequest(url).then(function(response){
                //     // The requested data
                //     console.log(response.data);
                // });
                //routeTask.solve(routeParams).then(showRoute);

                routeTask.solve(routeParams).then(function(results){
                    console.log(results.routeResults[0].directions.totalTime);
                    drivingTimeArray[i] = results.routeResults[0].directions.totalTime;
                    updateDiff();
                });
            });

        }


        function diffODMatrix(pt) {
            mapView.graphics.removeAll();
            routeLayer.graphics.removeAll();

            transitTimeArray = new Array(polyCentroids.length).fill(1000);
            drivingTimeArray = new Array(polyCentroids.length).fill(1000);
            diffTimeArray = new Array(polyCentroids.length).fill(1000);

            var mp = webMercatorUtils.webMercatorToGeographic(pt);
            var outSpatialReference = {
                wkid: 4326
            };

            dstGraphic = new Graphic({
                geometry: mp,
                symbol: dstMarkerSymbol
            });
            mapView.graphics.add(dstGraphic);


            var outSpatialReference = {
                wkid: 4326
            };
            // projects an array of points
            //console.log(polyCentroids);
            //var projectedPoints = projection.project(polyCentroids, outSpatialReference);
            projection.load().then(function() {
                var projectedPoints = projection.project(polyCentroids, outSpatialReference);
                //console.log(projectedPoints);


                projectedPoints.forEach(function(poly, i) {
                    routeTTAPIParam.body = JSON.stringify({
                        "locations": [
                            {
                                "id": "src",
                                "coords": {
                                    "lat": poly.y,
                                    "lng": poly.x
                                }
                            },
                            {
                                "id": "dst",
                                "coords": {
                                    "lat": mp.y,
                                    "lng": mp.x
                                }
                            },
                        ],
                        "departure_searches": [{
                            "id": "departure search example",
                            "departure_location_id": "src",
                            "arrival_location_ids": [
                                "dst"
                            ],
                            "transportation": {
                                "type": "driving"
                            },
                            "departure_time": (new Date()).toISOString(),
                            "properties": ["travel_time", "distance", "route"]
                        }]
                    });
                    //console.log(routeTTAPIParam);
                    esriRequest(routeTTimeAPI.url, routeTTAPIParam).then(function(response){
                        // The requested data
                        //console.log(response.data);
                        //console.log(response.data.results[0].locations[0].properties[0].travel_time/60);

                        transitTimeArray[i] = response.data.results[0].locations[0].properties[0].travel_time/60;
                        updateDiff(i);
                    }); //request


                    srcGraphic = new Graphic({
                        geometry: poly,
                        symbol: srcMarkerSymbol
                    });
                    mapView.graphics.add(srcGraphic);
                    routeParams.stops.features.pop();
                    routeParams.stops.features.pop();
                    routeParams.stops.features.push(srcGraphic);
                    routeParams.stops.features.push(dstGraphic);

                    routeParams.startTime = new Date();
                    routeTask.solve(routeParams).then(function(results){
                        //console.log(results.routeResults[0].directions.totalTime);
                        drivingTimeArray[i] = results.routeResults[0].directions.totalTime;
                        updateDiff(i);
                    });



                }); //foreach
            }); //load
        }

        function updateDiff(i) {
            //console.log(diffTimeArray);
            //for (i=0; i<diffTimeArray.length; i++) {
                diffTimeArray[i] = Math.abs(transitTimeArray[i] - drivingTimeArray[i]);
                //diffTimeArray[i] = Math.abs( drivingTimeArray[i]);
            //}
            //console.log(diffTimeArray);
            neighborhoodLayer.queryFeatures().then(function(results){
                // prints an array of all the features in the service to the console
                //console.log(results.features);
                var feature = results.features[i];
                //results.features.forEach(function(feature, i) {
                    //return feature.geometry;
                    var fillSymbol = {
                        type: "simple-fill", // autocasts as new SimpleFillSymbol()
                        color: [255, 255, (diffTimeArray[i]/120.0)*255.0, 0.6],
                    };
                    //feature.symbol = fillSymbol;

                    // Add the geometry and symbol to a new graphic
                    var polygonGraphic = new Graphic({
                        geometry: feature.geometry,
                        symbol: fillSymbol
                    });
                    routeLayer.add(polygonGraphic);
               // });

            });
        }

    });
</script>

</body>
</html>